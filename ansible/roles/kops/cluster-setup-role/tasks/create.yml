---


- name: setupcluster
  vars:
    nodecount: 3
  shell: kops create cluster 
         --node-size t2.micro 
         --master-size t2.micro 
         --kubernetes-version=1.13.0 
         --zones=us-east-1b 
         --master-zones=us-east-1b 
         --node-count={{nodecount}} {{clustername.stdout[:-1]}}
         --state=s3://{{clustername.stdout[:-1]}}
         --ssh-public-key=~/.ssh/id_rsa.pub


- name: updatecluster
  shell: kops update cluster {{clustername.stdout[:-1]}} 
         --state=s3://{{clustername.stdout[:-1]}}
         --ssh-public-key=~/.ssh/id_rsa.pub --yes

- pause:
    minutes: 1


- name: validate cluster
  shell: kops validate cluster --name {{clustername.stdout[:-1]}}
        --state=s3://{{clustername.stdout[:-1]}}

  delegate_to: localhost
  register: result
  until: result.stdout.find("is ready") !=-1
  retries: 14
  delay: 60